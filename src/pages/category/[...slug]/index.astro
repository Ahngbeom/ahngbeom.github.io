---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Pagination from '../../../components/Pagination.astro';
import PostCard from '../../../components/PostCard.astro';
import { filterPostsByCategory, getCategoryPathKeys, getPublishedPosts, paginatePosts } from '../../../lib/content';
import { siteConfig } from '../../../config/site';

export async function getStaticPaths() {
  const posts = await getPublishedPosts();
  const keys = getCategoryPathKeys(posts);

  return Array.from(keys.keys()).map((pathValue) => ({
    params: { slug: pathValue },
    props: { segments: pathValue.split('/') }
  }));
}

const { segments } = Astro.props;
const allPosts = await getPublishedPosts();
const filtered = filterPostsByCategory(allPosts, segments);
const pagination = paginatePosts(filtered, 1, siteConfig.layout.postsPerPage);
const title = segments.join(' > ');
---

<BaseLayout title={`${title} | ahngbeom`} subtitle={`Category: ${title}`}>
  <section class="category-page">
    <h2 class="section-title">{title}</h2>
    <p class="meta">{filtered.length} posts</p>
    <div class="post-list">
      {pagination.items.map((post) => (
        <PostCard post={post} />
      ))}
    </div>
    <Pagination currentPage={pagination.currentPage} totalPages={pagination.totalPages} basePath={`/category/${segments.map(encodeURIComponent).join('/')}/`} />
  </section>
</BaseLayout>

<style>
  .category-page {
    margin-top: 1.2rem;
  }

  .post-list {
    margin-top: 1rem;
    display: grid;
    gap: 0.8rem;
  }
</style>
