---
title: "3. ì–´ëŒ‘í„° êµ¬í˜„ì²´ ì„¤ê³„"
date: "2025-09-02"
tags:
    - Spring Boot 3.4.0
    - Java 21
    - MySQL 8
    - JPA
    - Adapter Pattern
    - PG Integration
---

> **PaymentPort ì¸í„°í˜ì´ìŠ¤ì˜ ì‹¤ì œ êµ¬í˜„ì²´ ì„¤ê³„**
>
> TossAdapterë¥¼ ì˜ˆì‹œë¡œ ì‹¤ì œ PGì‚¬ ì—°ë™ì„ ìˆ˜í–‰í•˜ëŠ” Adapter êµ¬í˜„ì²´ì˜ ìƒì„¸ ì„¤ê³„ì™€ ì—ëŸ¬ ì²˜ë¦¬ ì „ëµì„ ë‹¤ë£¹ë‹ˆë‹¤.

---

## ğŸ¯ êµ¬í˜„ ëª©í‘œ

### PaymentAdapterì˜ ì—­í• 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      PaymentPort (Interface)         â”‚
â”‚  - payment()                         â”‚
â”‚  - read()                            â”‚
â”‚  - refund()                          â”‚
â”‚  - sendBill()                        â”‚
â”‚  - destroy()                         â”‚
â”‚  - callback()                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â–²
                  â”‚ implements
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      TossAdapter (Implementation)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ“ PGì‚¬ API í˜¸ì¶œ                     â”‚
â”‚  âœ“ ë°ì´í„° ë³€í™˜ (DTO â†” Entity)       â”‚
â”‚  âœ“ ì—ëŸ¬ í•¸ë“¤ë§                       â”‚
â”‚  âœ“ íŠ¸ëœì­ì…˜ ê´€ë¦¬                     â”‚
â”‚  âœ“ ì½œë°± ì²˜ë¦¬                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**í•µì‹¬ ì±…ì„:**

- âœ… PGì‚¬ APIì™€ì˜ ì‹¤ì œ í†µì‹ 
- âœ… ìš”ì²­/ì‘ë‹µ ë°ì´í„° ë³€í™˜
- âœ… Payment Schema DB ì €ì¥
- âœ… ì—ëŸ¬ ìƒí™© ì²˜ë¦¬ ë° ë³µêµ¬
- âœ… ì„±ê³µ/ì‹¤íŒ¨ ì½œë°± ì‹¤í–‰

---

## ğŸ—ï¸ TossAdapter êµ¬í˜„

### í´ë˜ìŠ¤ êµ¬ì¡°

```java
@Slf4j
@Component
@Transactional(transactionManager = "paymentTransactionManager")
@RequiredArgsConstructor
public class TossAdapter implements PaymentPort {

  // PGì‚¬ API í†µì‹ 
  private final TossPgClient tossPgClient;

  // ë°ì´í„° ì˜ì†ì„± ê´€ë¦¬
  private final TransactionService transactionService;
  private final MethodService methodService;
  private final ApiLogService apiLogService;

  // ìœ í‹¸ë¦¬í‹°
  private final ObjectMapper objectMapper;
  private final AES256Crypto aesCrypto;

  // ì„¤ì •ê°’
  @Value("${payment.toss.api-key}")
  private String tossApiKey;

  @Value("${payment.toss.secret-key}")
  private String tossSecretKey;

  // ... ë©”ì„œë“œ êµ¬í˜„
}
```

### ì£¼ìš” ì–´ë…¸í…Œì´ì…˜ ì„¤ëª…

#### `@Component`

- Spring Beanìœ¼ë¡œ ë“±ë¡
- PaymentPortFactoryê°€ ìë™ìœ¼ë¡œ ê°ì§€í•˜ì—¬ Mapì— ë“±ë¡

#### `@Transactional(transactionManager = "paymentTransactionManager")`

- **Payment Schema ì „ìš© íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €** ì‚¬ìš©
- Main Schemaì™€ ë…ë¦½ì ì¸ íŠ¸ëœì­ì…˜ ê´€ë¦¬
- ì—ëŸ¬ ë°œìƒ ì‹œ Payment DBë§Œ ë¡¤ë°±

```java
// PaymentDataSourceConfig.java
@Bean
public PlatformTransactionManager paymentTransactionManager(
    @Qualifier("paymentEntityManagerFactory") EntityManagerFactory emf) {
  return new JpaTransactionManager(emf);
}
```

#### `@RequiredArgsConstructor`

- final í•„ë“œì— ëŒ€í•œ ìƒì„±ì ìë™ ìƒì„±
- ì˜ì¡´ì„± ì£¼ì… ê°„ì†Œí™”

---

## ğŸ’³ payment() ë©”ì„œë“œ êµ¬í˜„

### ê²°ì œ ìš”ì²­ ì²˜ë¦¬ í”Œë¡œìš°

```
1. ìš”ì²­ ë°ì´í„° ë³€í™˜
   â””â†’ PaymentRequest DTO ìƒì„±

2. íŠ¸ëœì­ì…˜ ìƒì„± ë° ì €ì¥
   â””â†’ Payment Schema: transactions í…Œì´ë¸”

3. UUID ì½œë°± ì‹¤í–‰
   â””â†’ í´ë¼ì´ì–¸íŠ¸ì— íŠ¸ëœì­ì…˜ ID ì¦‰ì‹œ ì‘ë‹µ

4. PGì‚¬ API í˜¸ì¶œ
   â””â†’ TossPgClient.payment()

5. API ë¡œê·¸ ì €ì¥
   â””â†’ pg_api_logs í…Œì´ë¸”

6. ì‘ë‹µ ì²˜ë¦¬
   â”œâ†’ ì„±ê³µ: successRunnable ì‹¤í–‰
   â””â†’ ì‹¤íŒ¨: errorRunnable ì‹¤í–‰

7. íŠ¸ëœì­ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
   â””â†’ transactions.status ë³€ê²½

8. ìµœì¢… ì‘ë‹µ ë°˜í™˜
```

### ì‹¤ì œ êµ¬í˜„ ì½”ë“œ

```java
@Override
public PaymentResponse payment(
    PaymentRequest payload,
    PaymentAdapterRunnable<BaseResponse> runnable) {

  try {
    // 1. ìš”ì²­ ë°ì´í„° ë³€í™˜
    TossPaymentRequest request = TossPaymentRequest.from(payload);

    // 2. íŠ¸ëœì­ì…˜ ì—”í‹°í‹° ìƒì„± ë° ì €ì¥
    Transaction entity = transactionService.create(Transaction.builder()
        .pgCompany("TOSS")
        .transactionType("PAYMENT")
        .amount(payload.getAmount())
        .currency("KRW")
        .status("PENDING")
        .pgRequestData(objectMapper.writeValueAsString(request))
        .build());

    // 3. UUID ì½œë°± ì‹¤í–‰ (ì¦‰ì‹œ ì‘ë‹µì„ ìœ„í•´)
    runnable.createUuidRunnable().run(entity.getUuid().toString());

    // 4. PGì‚¬ API í˜¸ì¶œ
    TossPaymentResponse response = tossPgClient.payment(request);

    // 5. API í†µì‹  ë¡œê·¸ ì €ì¥
    apiLogService.log(ApiLog.builder()
        .pgCompany("TOSS")
        .apiEndpoint("/v1/payments")
        .httpMethod("POST")
        .requestBody(objectMapper.writeValueAsString(request))
        .responseBody(objectMapper.writeValueAsString(response))
        .responseStatus(200)
        .success(response.isSuccess())
        .build());

    // 6. ì‘ë‹µ ì²˜ë¦¬
    if (response.isSuccess()) {
      // ì„±ê³µ ì²˜ë¦¬
      entity.setPgTransactionId(response.getPaymentKey());
      entity.setStatus("SUCCESS");
      entity.setPgResponseData(objectMapper.writeValueAsString(response));
      entity.setCompletedAt(LocalDateTime.now());

      // ì„±ê³µ ì½œë°± ì‹¤í–‰
      runnable.successRunnable().run(entity.getUuid().toString(), response);

      // 7. íŠ¸ëœì­ì…˜ ì—…ë°ì´íŠ¸
      transactionService.update(entity);

      // 8. ìµœì¢… ì‘ë‹µ
      return PaymentResponse.builder()
          .transactionId(entity.getUuid().toString())
          .pgTransactionId(response.getPaymentKey())
          .status(PaymentStatus.SUCCESS)
          .message("ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤")
          .paidAmount(response.getTotalAmount())
          .paidAt(entity.getCompletedAt())
          .rawData(response)
          .build();

    } else {
      // ì‹¤íŒ¨ ì²˜ë¦¬
      entity.setStatus("FAILED");
      entity.setPgResponseData(objectMapper.writeValueAsString(response));

      // ì—ëŸ¬ ì½œë°± ì‹¤í–‰
      runnable.errorRunnable().run(
          entity.getUuid().toString(),
          new PaymentException(response.getErrorMessage())
      );

      transactionService.update(entity);

      return PaymentResponse.builder()
          .transactionId(entity.getUuid().toString())
          .status(PaymentStatus.FAILED)
          .message(response.getErrorMessage())
          .rawData(response)
          .build();
    }

  } catch (Exception e) {
    log.error("ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸ ë°œìƒ: {}", e.getMessage(), e);

    // ì˜ˆì™¸ ì½œë°± ì‹¤í–‰
    runnable.errorRunnable().run(null, e);

    throw new PaymentException("ê²°ì œ ì²˜ë¦¬ ì‹¤íŒ¨", e);
  }
}
```

---

## ğŸ“– read() ë©”ì„œë“œ êµ¬í˜„

### ê²°ì œ ì •ë³´ ì¡°íšŒ

```java
@Override
public ReadResponse read(ReadRequest payload) {
  try {
    // 1. PGì‚¬ ì¡°íšŒ ìš”ì²­
    TossReadRequest request = TossReadRequest.builder()
        .paymentKey(payload.getPgTransactionId())
        .build();

    TossReadResponse response = tossPgClient.read(request);

    // 2. API ë¡œê·¸ ì €ì¥
    apiLogService.log(ApiLog.builder()
        .pgCompany("TOSS")
        .apiEndpoint("/v1/payments/" + payload.getPgTransactionId())
        .httpMethod("GET")
        .responseBody(objectMapper.writeValueAsString(response))
        .success(true)
        .build());

    // 3. ì‘ë‹µ ë³€í™˜
    return ReadResponse.builder()
        .transactionId(response.getOrderId())
        .pgTransactionId(response.getPaymentKey())
        .amount(response.getTotalAmount())
        .status(mapTossStatus(response.getStatus()))
        .paidAt(response.getApprovedAt())
        .rawData(response)
        .build();

  } catch (Exception e) {
    log.error("ê²°ì œ ì¡°íšŒ ì¤‘ ì˜ˆì™¸ ë°œìƒ: {}", e.getMessage(), e);
    throw new PaymentException("ê²°ì œ ì¡°íšŒ ì‹¤íŒ¨", e);
  }
}

/**
 * Toss ê²°ì œ ìƒíƒœë¥¼ ê³µí†µ PaymentStatusë¡œ ë³€í™˜
 */
private PaymentStatus mapTossStatus(String tossStatus) {
  return switch (tossStatus) {
    case "READY" -> PaymentStatus.PENDING;
    case "DONE" -> PaymentStatus.SUCCESS;
    case "CANCELED" -> PaymentStatus.CANCELLED;
    case "PARTIAL_CANCELED" -> PaymentStatus.REFUNDED;
    case "ABORTED", "EXPIRED" -> PaymentStatus.FAILED;
    default -> PaymentStatus.PENDING;
  };
}
```

---

## ğŸ”„ refund() ë©”ì„œë“œ êµ¬í˜„

### í™˜ë¶ˆ ì²˜ë¦¬ í”Œë¡œìš°

```java
@Override
public RefundResponse refund(
    RefundRequest payload,
    PaymentAdapterRunnable<RefundResponse> runnable) {

  try {
    // 1. ì›ë³¸ íŠ¸ëœì­ì…˜ ì¡°íšŒ
    Transaction originalTx = transactionService
        .findByPgTransactionId(payload.getPgTransactionId())
        .orElseThrow(() -> new PaymentException("ì›ë³¸ ê²°ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"));

    // 2. í™˜ë¶ˆ íŠ¸ëœì­ì…˜ ìƒì„±
    Transaction refundTx = transactionService.create(Transaction.builder()
        .pgCompany("TOSS")
        .transactionType("REFUND")
        .amount(payload.getRefundAmount())
        .currency("KRW")
        .status("PENDING")
        .build());

    // 3. PGì‚¬ í™˜ë¶ˆ ìš”ì²­
    TossRefundRequest request = TossRefundRequest.builder()
        .paymentKey(originalTx.getPgTransactionId())
        .cancelReason(payload.getReason())
        .cancelAmount(payload.getRefundAmount())
        .build();

    TossRefundResponse response = tossPgClient.refund(request);

    // 4. API ë¡œê·¸ ì €ì¥
    apiLogService.log(ApiLog.builder()
        .pgCompany("TOSS")
        .apiEndpoint("/v1/payments/" + originalTx.getPgTransactionId() + "/cancel")
        .httpMethod("POST")
        .requestBody(objectMapper.writeValueAsString(request))
        .responseBody(objectMapper.writeValueAsString(response))
        .success(response.isSuccess())
        .build());

    // 5. ê²°ê³¼ ì²˜ë¦¬
    if (response.isSuccess()) {
      refundTx.setStatus("SUCCESS");
      refundTx.setPgResponseData(objectMapper.writeValueAsString(response));
      refundTx.setCompletedAt(LocalDateTime.now());

      // ì›ë³¸ íŠ¸ëœì­ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
      originalTx.setStatus("REFUNDED");

      runnable.successRunnable().run(refundTx.getUuid().toString(), null);

      transactionService.update(refundTx);
      transactionService.update(originalTx);

      return RefundResponse.builder()
          .transactionId(refundTx.getUuid().toString())
          .originalTransactionId(originalTx.getUuid().toString())
          .status(PaymentStatus.REFUNDED)
          .refundedAmount(payload.getRefundAmount())
          .message("í™˜ë¶ˆì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤")
          .build();

    } else {
      refundTx.setStatus("FAILED");
      runnable.errorRunnable().run(
          refundTx.getUuid().toString(),
          new PaymentException(response.getErrorMessage())
      );

      transactionService.update(refundTx);

      throw new PaymentException(response.getErrorMessage());
    }

  } catch (Exception e) {
    log.error("í™˜ë¶ˆ ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸ ë°œìƒ: {}", e.getMessage(), e);
    runnable.errorRunnable().run(null, e);
    throw new PaymentException("í™˜ë¶ˆ ì²˜ë¦¬ ì‹¤íŒ¨", e);
  }
}
```

---

## ğŸ“± sendBill() ë©”ì„œë“œ êµ¬í˜„

### ì¹´ì¹´ì˜¤í†¡ ì²­êµ¬ì„œ ë°œì†¡

```java
@Override
public KakaoTalkResponse sendBill(
    TalkRequest payload,
    PaymentAdapterRunnable<KakaoTalkResponse> runnable) {

  try {
    // 1. ì²­êµ¬ì„œ íŠ¸ëœì­ì…˜ ìƒì„±
    Transaction entity = transactionService.create(Transaction.builder()
        .pgCompany("TOSS")
        .transactionType("BILL")
        .amount(payload.getAmount())
        .currency("KRW")
        .status("PENDING")
        .build());

    // 2. ì¹´ì¹´ì˜¤í†¡ ì²­êµ¬ì„œ ìš”ì²­ ìƒì„±
    TossBillRequest request = TossBillRequest.builder()
        .orderId(entity.getUuid().toString())
        .orderName(payload.getProductName())
        .amount(payload.getAmount())
        .customerName(payload.getCustomerName())
        .customerMobilePhone(payload.getCustomerPhone())
        .validHours(24) // 24ì‹œê°„ ìœ íš¨
        .build();

    // 3. PGì‚¬ API í˜¸ì¶œ
    TossBillResponse response = tossPgClient.sendBill(request);

    // 4. API ë¡œê·¸
    apiLogService.log(ApiLog.builder()
        .pgCompany("TOSS")
        .apiEndpoint("/v1/billing/kakao")
        .httpMethod("POST")
        .requestBody(objectMapper.writeValueAsString(request))
        .responseBody(objectMapper.writeValueAsString(response))
        .success(response.isSuccess())
        .build());

    // 5. ê²°ê³¼ ì²˜ë¦¬
    if (response.isSuccess()) {
      entity.setPgTransactionId(response.getBillKey());
      entity.setStatus("SENT");
      entity.setPgResponseData(objectMapper.writeValueAsString(response));

      runnable.successRunnable().run(entity.getUuid().toString(), null);

      transactionService.update(entity);

      return KakaoTalkResponse.builder()
          .transactionId(entity.getUuid().toString())
          .billKey(response.getBillKey())
          .billUrl(response.getCheckoutUrl())
          .expiresAt(LocalDateTime.now().plusHours(24))
          .message("ì²­êµ¬ì„œê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤")
          .build();

    } else {
      entity.setStatus("FAILED");
      runnable.errorRunnable().run(
          entity.getUuid().toString(),
          new PaymentException(response.getErrorMessage())
      );

      transactionService.update(entity);

      throw new PaymentException(response.getErrorMessage());
    }

  } catch (Exception e) {
    log.error("ì²­êµ¬ì„œ ë°œì†¡ ì¤‘ ì˜ˆì™¸ ë°œìƒ: {}", e.getMessage(), e);
    runnable.errorRunnable().run(null, e);
    throw new PaymentException("ì²­êµ¬ì„œ ë°œì†¡ ì‹¤íŒ¨", e);
  }
}
```

---

## ğŸ” callback() ë©”ì„œë“œ êµ¬í˜„

### PGì‚¬ Webhook ì²˜ë¦¬

```java
@Override
public PaymentCallbackResponse callback(
    PaymentCallbackRequest payload,
    String hash) {

  try {
    // 1. í•´ì‹œ ê²€ì¦
    String decryptedHash = aesCrypto.decrypt(hash);
    UUID transactionUuid = UUID.fromString(decryptedHash);

    // 2. íŠ¸ëœì­ì…˜ ì¡°íšŒ
    Transaction entity = transactionService
        .findByUuid(transactionUuid)
        .orElseThrow(() -> new PaymentException("ìœ íš¨í•˜ì§€ ì•Šì€ íŠ¸ëœì­ì…˜ì…ë‹ˆë‹¤"));

    // 3. API ë¡œê·¸
    apiLogService.log(ApiLog.builder()
        .pgCompany("TOSS")
        .apiEndpoint("/callback")
        .httpMethod("POST")
        .requestBody(objectMapper.writeValueAsString(payload))
        .success(true)
        .build());

    // 4. ê²°ì œ ìƒíƒœ ì—…ë°ì´íŠ¸
    if ("SUCCESS".equals(payload.getStatus())) {
      entity.setStatus("SUCCESS");
      entity.setPgTransactionId(payload.getPaymentKey());
      entity.setCompletedAt(LocalDateTime.now());

    } else if ("FAILED".equals(payload.getStatus())) {
      entity.setStatus("FAILED");
    }

    entity.setPgResponseData(objectMapper.writeValueAsString(payload));
    transactionService.update(entity);

    // 5. ì½œë°± ì‘ë‹µ
    return PaymentCallbackResponse.builder()
        .transactionId(entity.getUuid().toString())
        .status(entity.getStatus())
        .message("ì½œë°± ì²˜ë¦¬ ì™„ë£Œ")
        .build();

  } catch (Exception e) {
    log.error("ì½œë°± ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸ ë°œìƒ: {}", e.getMessage(), e);
    throw new PaymentException("ì½œë°± ì²˜ë¦¬ ì‹¤íŒ¨", e);
  }
}
```

---

## âš ï¸ ì—ëŸ¬ ì²˜ë¦¬ ì „ëµ

### 1. ì—ëŸ¬ ê³„ì¸µ êµ¬ì¡°

```java
/**
 * ê²°ì œ ì„œë¹„ìŠ¤ ìµœìƒìœ„ ì˜ˆì™¸
 */
public class PaymentException extends RuntimeException {
  private final String errorCode;
  private final Object details;

  public PaymentException(String message) {
    super(message);
    this.errorCode = "PAYMENT_ERROR";
    this.details = null;
  }

  public PaymentException(String message, Throwable cause) {
    super(message, cause);
    this.errorCode = "PAYMENT_ERROR";
    this.details = null;
  }

  public PaymentException(String errorCode, String message, Object details) {
    super(message);
    this.errorCode = errorCode;
    this.details = details;
  }
}

/**
 * PGì‚¬ API í†µì‹  ì‹¤íŒ¨
 */
public class PgApiException extends PaymentException {
  public PgApiException(String message, Throwable cause) {
    super("PG_API_ERROR", message, cause);
  }
}

/**
 * ê²°ì œ ìƒíƒœ ë¶ˆì¼ì¹˜
 */
public class PaymentStatusException extends PaymentException {
  public PaymentStatusException(String expected, String actual) {
    super("PAYMENT_STATUS_ERROR",
        String.format("ì˜ˆìƒ ìƒíƒœ: %s, ì‹¤ì œ ìƒíƒœ: %s", expected, actual),
        Map.of("expected", expected, "actual", actual));
  }
}
```

### 2. ì¬ì‹œë„ ë¡œì§

```java
@Retryable(
    value = {PgApiException.class},
    maxAttempts = 3,
    backoff = @Backoff(delay = 1000, multiplier = 2)
)
public TossPaymentResponse callPgApiWithRetry(TossPaymentRequest request) {
  try {
    return tossPgClient.payment(request);
  } catch (Exception e) {
    log.warn("PG API í˜¸ì¶œ ì‹¤íŒ¨, ì¬ì‹œë„ ì˜ˆì •: {}", e.getMessage());
    throw new PgApiException("PG API í˜¸ì¶œ ì‹¤íŒ¨", e);
  }
}
```

### 3. Circuit Breaker ì ìš©

```java
@CircuitBreaker(
    name = "tossPgCircuit",
    fallbackMethod = "paymentFallback"
)
public PaymentResponse payment(PaymentRequest payload, ...) {
  // ì‹¤ì œ ê²°ì œ ë¡œì§
}

/**
 * Circuit Open ì‹œ ëŒ€ì²´ ë©”ì„œë“œ
 */
private PaymentResponse paymentFallback(
    PaymentRequest payload,
    Exception e) {

  log.error("ê²°ì œ ì„œë¹„ìŠ¤ Circuit Open: {}", e.getMessage());

  return PaymentResponse.builder()
      .status(PaymentStatus.FAILED)
      .message("ì¼ì‹œì ìœ¼ë¡œ ê²°ì œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.")
      .build();
}
```

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì½”ë“œ

### Mock Adapter í™œìš©

```java
@Test
void ê²°ì œ_ì„±ê³µ_í…ŒìŠ¤íŠ¸() {
  // Given
  PaymentRequest request = PaymentRequest.builder()
      .orderId("ORDER_123")
      .amount(10000L)
      .build();

  AtomicReference<String> capturedUuid = new AtomicReference<>();

  PaymentAdapterRunnable<BaseResponse> runnable =
      PaymentAdapterRunnable.paymentRunnable(
          uuid -> capturedUuid.set(uuid),
          (uuid, response) -> log.info("Success: {}", uuid),
          (uuid, error) -> log.error("Error: {}", error)
      );

  // When
  PaymentResponse response = tossAdapter.payment(request, runnable);

  // Then
  assertThat(response.getStatus()).isEqualTo(PaymentStatus.SUCCESS);
  assertThat(response.getPaidAmount()).isEqualTo(10000L);
  assertThat(capturedUuid.get()).isNotNull();
}

@Test
void í™˜ë¶ˆ_ì„±ê³µ_í…ŒìŠ¤íŠ¸() {
  // Given
  String pgTransactionId = "TOSS_PAY_123";
  RefundRequest request = RefundRequest.builder()
      .pgTransactionId(pgTransactionId)
      .refundAmount(5000L)
      .reason("ê³ ê° ìš”ì²­")
      .build();

  PaymentAdapterRunnable<RefundResponse> runnable =
      PaymentAdapterRunnable.refundRunnable(
          (uuid, response) -> log.info("Refund success"),
          (uuid, error) -> log.error("Refund failed")
      );

  // When
  RefundResponse response = tossAdapter.refund(request, runnable);

  // Then
  assertThat(response.getStatus()).isEqualTo(PaymentStatus.REFUNDED);
  assertThat(response.getRefundedAmount()).isEqualTo(5000L);
}
```

---

## ğŸ’¡ ì„¤ê³„ ì›ì¹™ ì •ë¦¬

### 1ï¸âƒ£ ë‹¨ì¼ ì±…ì„ ì›ì¹™ (SRP)

> TossAdapterëŠ” Toss PGì‚¬ ì—°ë™ë§Œ ë‹´ë‹¹

```java
// âœ… Good: Toss ì „ìš© ë¡œì§ë§Œ
public class TossAdapter implements PaymentPort {
  // Toss API ì—°ë™ë§Œ ë‹´ë‹¹
}

// âŒ Bad: ì—¬ëŸ¬ PGì‚¬ í˜¼ì¬
public class PaymentAdapter implements PaymentPort {
  if (pgCompany.equals("TOSS")) { ... }
  else if (pgCompany.equals("NICE")) { ... }
}
```

### 2ï¸âƒ£ ì˜ì¡´ì„± ì—­ì „ ì›ì¹™ (DIP)

> êµ¬ì²´ í´ë˜ìŠ¤ê°€ ì•„ë‹Œ ì¸í„°í˜ì´ìŠ¤ì— ì˜ì¡´

```java
// âœ… Good: ì¸í„°í˜ì´ìŠ¤ ì˜ì¡´
private final PaymentPort paymentPort;

// âŒ Bad: êµ¬ì²´ í´ë˜ìŠ¤ ì˜ì¡´
private final TossAdapter tossAdapter;
```

### 3ï¸âƒ£ ê°œë°©-íì‡„ ì›ì¹™ (OCP)

> ì‹ ê·œ PGì‚¬ ì¶”ê°€ ì‹œ ê¸°ì¡´ ì½”ë“œ ìˆ˜ì • ì—†ìŒ

```java
// âœ… ìƒˆë¡œìš´ Adapter ì¶”ê°€
@Component
public class KakaoPayAdapter implements PaymentPort {
  // KakaoPay êµ¬í˜„
}
// Factoryê°€ ìë™ìœ¼ë¡œ ê°ì§€í•˜ì—¬ ë“±ë¡
```

---

## ğŸ“ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] TossAdapter êµ¬í˜„ ì™„ë£Œ
- [ ] ëª¨ë“  ë©”ì„œë“œì— ì—ëŸ¬ í•¸ë“¤ë§ ì¶”ê°€
- [ ] API ë¡œê·¸ ì €ì¥ êµ¬í˜„
- [ ] íŠ¸ëœì­ì…˜ ê´€ë¦¬ ì„¤ì •
- [ ] Runnable ì½œë°± ëª¨ë‘ í˜¸ì¶œ
- [ ] í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±
- [ ] ì¬ì‹œë„ ë¡œì§ ì ìš©
- [ ] Circuit Breaker ì„¤ì •

---

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„

[4. PGì‚¬ ì™¸ë¶€ API ìš”ì²­ RestClient](/Back-End/ê²°ì œ-ì„œë¹„ìŠ¤-MSA-ì•„í‚¤í…ì³-ì „í™˜/4-PGì‚¬-ì™¸ë¶€-API-ìš”ì²­-RestClient)ë¡œ ì´ë™í•˜ì—¬ ì‹¤ì œ HTTP í†µì‹  êµ¬í˜„ì„ í™•ì¸í•©ë‹ˆë‹¤.

**Adapter êµ¬í˜„ ì™„ë£Œ! ì´ì œ HTTP í´ë¼ì´ì–¸íŠ¸ ì„¤ì •ìœ¼ë¡œ!** ğŸ’ª